function BPBMurlBase64ToUint8Array(e){for(var s=(e+"=".repeat((4-e.length%4)%4)).replace(/\-/g,"+").replace(/_/g,"/"),t=window.atob(s),a=new Uint8Array(t.length),i=0;i<t.length;++i)a[i]=t.charCodeAt(i);return a}function BBPMNotice(e){"function"==typeof window.BMAppNoticeToast?window.BMAppNoticeToast("",e,1e4):BPBMJQ.amaran({theme:"colorful",content:{bgcolor:"black",color:"#fff",message:e},sticky:!1,closeOnClick:!0,closeButton:!0,delay:1e4,position:"bottom right"})}function BBPMShowError(e,s){void 0===s&&(s=1e4),"function"==typeof window.BMAppErrorToast?window.BMAppErrorToast("",e,s):BPBMJQ.amaran({theme:"colorful",content:{bgcolor:"#c0392b",color:"#fff",message:e},sticky:!1,closeOnClick:!0,closeButton:!0,delay:s,position:"bottom right"})}function BBPMOpenMiniChat(e,s){BPBMJQ(document).trigger("bp-better-messages-open-mini-chat",[e,s])}function BBPMOpenPrivateThread(e){BPBMJQ(document).trigger("bp-better-messages-open-private-thread",[e])}function BPBMGetOnlineUsers(){return BPBMOnlineUsers}var BPBMJQ=jQuery.noConflict(),BPBMEvent=Event;BPBMJQ.fn.bpbmtooltip=jQuery.fn.tooltip;var BPBMOnlineUsers=[],urlSeparator=BP_Messages.url.split("?")[1]?"&":"?";!function(e){function s(s){var t=parseInt(s);isNaN(t)&&(t=0),document.dispatchEvent(new CustomEvent("bp-better-messages-update-unread",{detail:{unread:t}})),BP_Messages.total_unread=t,0===t&&e(".bp-messages-wrap .threads-list .thread .unread-count").html(""),"1"===BP_Messages.titleNotifications&&(isNaN(t)||t<=0?document.title=R:document.title="("+s+") "+R)}function t(s){void 0!==s[0].BPemojioneArea&&s[0].BPemojioneArea.trigger("change");var t=s.val();if(0===e(s).next(".bp-emojionearea").length)return t;var a=function(s){"<p>"!==(s=s.replace(/<p><\/p>/g,"")).substring(0,3)&&(s="<p>"+s);"</p>"!==s.substring(s.length-4)&&(s+="</p>");var t=e.parseHTML(s);e.each(t,function(s,t){var a=e(this);e.each(a.find("img.emojioneemoji,img.emojione"),function(){var s=e(this);s.replaceWith(s.attr("alt"))}),a.BPBMremoveAttributes(),a.find("*").BPBMremoveAttributes()});var a="";e.each(t,function(){a+=this.outerHTML}),"<p></p>"===a&&(a="");return a=a.replace(/&amp;/g,"&")}(t);return s.val(a),a}function a(){"function"==typeof e.fn.BPBMmagnificPopup&&e(".bp-messages-wrap .list .messages-stack .content .messages-list li .images").each(function(){var s=e(this),t=s.closest("li");s.BPBMmagnificPopup({delegate:"a",key:t.attr("data-id"),type:"image",gallery:{enabled:!0}})})}function i(s){if(0===s.length)return!1;0===e("."+se).length&&e('<div class="'+se+'"></div>').insertBefore(s);var t=s;t.addClass("bp-messages-mobile"),t.attr("id","bp-better-messages-mobile-view-container");var a=window.innerHeight;e("html").addClass("bp-messages-mobile").css("overflow","hidden"),e("body").addClass("bp-messages-mobile").css("min-height",a);var i=t.appendTo(e("body"));i.show();var r=0,n=i.find(".chat-header").outerHeight();r+=n,i.find(".chat-footer:visible").length>0&&(r+=i.find(".chat-footer:visible").outerHeight()),i.find(".reply").length>0&&(r+=i.find(".reply").outerHeight()),L.find(".bpbm-chat-content").css("max-height","calc( 100% - "+n+"px )");var o=a-r;i.find(".scroller").css({"max-height":"",height:o}),x(i),h(),P(),e(document).trigger("bp-better-messages-mobile-open"),A=!0}function r(){function a(){if(c)return!1}function r(){w++,e(".bp-messages-wrap.bbapp_hide_all, .bp-messages-wrap.bbapp_hide_all *").removeClass("bbapp_hide_all"),w<10&&setTimeout(function(){r()},500)}O=0!==e('html[dir="rtl"]').length,L=e(".bp-messages-wrap:not(.bp-better-messages-list, .bm-threads-list, #bp-better-messages-mini-mobile-open)");var o=e("#bp-better-messages-mini-mobile-container"),d=e("#bp-better-messages-mini-mobile-open");if(V||d.hide(),V&&"0"!==BP_Messages.mobileFullScreen){var c=/iPad|iPhone|iPod/.test(navigator.userAgent)&&!window.MSStream;e(document).on("touchmove",".bp-messages-wrap .chat-header,.bp-messages-wrap .reply",function(e){A&&e.preventDefault()}),e(document).on("focus blur",".bp-messages-wrap textarea, .bp-messages-wrap input",function(e){setTimeout(function(){a(),h()},300)}),e(window).resize(function(){L.hasClass("bp-messages-mobile")&&a()}),L.addClass("mobile-ready");var p,m=!1;"0"===BP_Messages.disableTapToOpen?(L.find(".bp-messages-mobile-tap").css("line-height",L.height()+"px"),L.on("touchend",".bp-messages-mobile-tap",function(e){if(1!=p&&!1===m){var s=BPBMJQ(e.target).closest(".bp-messages-wrap");s.hasClass("bp-messages-mobile")||(e.preventDefault(),e.stopImmediatePropagation(),i(s))}}).on("touchmove",function(e){p=!0}).on("touchstart",function(e){p=!1})):L.on("touchend",function(s){if(1!=p&&!1===m){var t=BPBMJQ(s.target).closest(".bp-messages-wrap");if(!t.hasClass("bp-messages-mobile")){s.preventDefault(),s.stopImmediatePropagation(),i(t);var a=e(s.originalEvent.target).closest(".thread");a.length>0&&a.click()}}}).on("touchmove",function(e){p=!0}).on("touchstart",function(e){p=!1})}e(document).on("click",".bp-messages-wrap .bpbm-gif .bpbm-gif-play",function(s){$=!0;var t=e(this),a=e(this).parent().find("video");t.remove(),a[0].play(),setTimeout(function(){$=!1},500)}),e(document).on("click",".bp-messages-wrap .mobileClose",function(s){var t=BPBMJQ(s.target).closest(".bp-messages-wrap");if(t.hasClass("bp-messages-mobile")){if(s.preventDefault(),s.stopImmediatePropagation(),m=!0,e("html").removeClass("bp-messages-mobile").css("overflow","auto"),t.removeClass("bp-messages-mobile").css("min-height",""),e("body").removeClass("bp-messages-mobile").css("min-height",""),A=!1,t.find(".bp-messages-mobile-tap").css("line-height",t.height()+"px"),t.is(o)&&o.hide(),t.is("#bp-better-messages-mobile-view-container")){var a=t;a.removeClass("bp-messages-mobile"),a.removeAttr("id");var i=e("."+se);a.insertBefore(i),i.remove()}e(window).trigger("resize"),setTimeout(function(){m=!1},100)}}),e(document).on("click",".bp-messages-wrap .expandingButtons",function(s){s.stopPropagation(),e(this).toggleClass("expandingButtonsOpen")}),d.on("click",function(t){t.preventDefault(),d.hasClass("loading")||(d.addClass("loading"),function(t){var a=e("#bp-better-messages-mini-mobile-container");a.addClass("bp-messages-mobile"),a.find(".bp-messages-mobile-tap").remove();var i=window.innerHeight;e("html").addClass("bp-messages-mobile").css("overflow","hidden"),e("body").addClass("bp-messages-mobile").css("min-height",i),L.addClass("bp-messages-mobile").css("min-height",i);var r=0,n=L.find(".chat-header").outerHeight();r=(r+=n)+L.find(".reply").outerHeight();var o=i-r;e(".scroller").css({"max-height":"",height:o}),L.find(".bpbm-chat-content").css("max-height","calc( 100% - "+n+"px )"),P(),a.show().html('<div class="loading-messages" style="display: block;line-height: '+o+'px">\n<div class="bounce1"></div>\n<div class="bounce2"></div>\n<div class="bounce3"></div>\n</div>');var d="?action=bp_messages_load_via_ajax&mobileFullScreen=1";void 0!==t.split("?")[1]&&(d="?"+t.split("?")[1]+"&action=bp_messages_load_via_ajax&mobileFullScreen=1");var c=BP_Messages.ajaxUrl+d;e.get(c,function(t){void 0!==t.total_unread&&s(t.total_unread),void 0!==t.errors&&e.each(t.errors,function(){BBPMShowError(this)});var i=t.html,r=e(i).filter(".bp-messages-wrap").html();a.html(r).show(),A=!0,l(),e("#bp-better-messages-mini-mobile-open").removeClass("loading")},"json")}(BP_Messages.baseUrl))});var g=!1,b=!1;if(e(".bp-messages-wrap:not(.bp-better-messages-mini,.bp-better-messages-list) .thread.scroller[data-users-json]").length>0?g=e(".bp-messages-wrap:not(.bp-better-messages-mini,.bp-better-messages-list) .thread.scroller[data-users-json]").attr("data-id"):e(".bp-messages-wrap:not(.bp-better-messages-mini,.bp-better-messages-list,#bp-better-messages-mini-mobile-container,.bm-threads-list) .threads-list").length>0&&(b=!0),V)if("1"===BP_Messages.autoFullScreen){if(g||b){e("#bp-better-messages-mini-mobile-open, #bp-better-messages-mini-mobile-container").remove();i(f=e(".bp-messages-wrap.mobile-ready.bp-messages-wrap-main, .bp-messages-wrap.mobile-ready.bp-messages-group-thread"))}else{var f=e(".bp-messages-wrap.bp-messages-wrap-bulk.mobile-ready");f.length>0&&i(f)}var w=0;r()}else(g||b)&&e("#bp-better-messages-mini-mobile-open, #bp-better-messages-mini-mobile-container").remove();"1"===BP_Messages.blockScroll&&e(".bp-messages-wrap").on("mousewheel DOMMouseScroll",".bpbm-os-viewport",function(s){var t=s.originalEvent,a=t.wheelDelta||-t.detail,i=s.currentTarget.scrollHeight-e(s.currentTarget).height();a>0?this.scrollTop<5&&s.preventDefault():i-this.scrollTop<5&&s.preventDefault()}),l(),void 0===BP_Messages.socket_server&&setInterval(function(){e.post(BP_Messages.ajaxUrl,{action:"bp_messages_last_activity_refresh"})},3e5),L.on("click",".threads-list .thread:not(.blocked)",function(s){if(0===e(s.target).closest(".pic").length&&0===e(s.target).closest(".delete").length&&0===e(s.target).closest(".deleted").length){s.preventDefault();v(e(this).attr("data-href"),e(this).closest(".bp-messages-wrap"))}}),e(document).on("click",G+" span.delete",function(s){s.preventDefault(),s.stopPropagation();var t=e(this).parent().parent(),a=(t.parent().parent(),e(t).attr("data-id")),i=e(t).height(),r=e(this).attr("data-nonce");e.post(BP_Messages.ajaxUrl,{action:"bp_messages_delete_thread",thread_id:a,nonce:r},function(s){if(s.result){var a=t.position().top;e(t).addClass("blocked"),e(t).find(".deleted").show().css({height:i,"line-height":i+"px",top:a+"px"})}else BBPMShowError(s.errors[0])})}),e(document).on("click",G+" a.undelete",function(s){s.preventDefault(),s.stopPropagation();var t=e(this).parent().parent(),a=e(t).attr("data-id");e(t).removeClass("blocked");var i=e(this).attr("data-nonce");e.post(BP_Messages.ajaxUrl,{action:"bp_messages_un_delete_thread",thread_id:a,nonce:i},function(s){s.result?(e(t).removeClass("blocked"),e(t).find(".deleted").hide()):BBPMShowError(s.errors[0])})}),L.on("click",".messages-list li .favorite",function(s){s.preventDefault(),s.stopPropagation();var t=e(this).parentsUntil(".messages-list","li").attr("data-id"),a="star";e(this).hasClass("active")&&(a="unstar"),e(this).toggleClass("active"),e.post(BP_Messages.ajaxUrl,{action:"bp_messages_favorite",message_id:t,thread_id:T,type:a},function(e){})}),L.on("click",".messages-list li .bpbm-reply",function(s){s.preventDefault(),s.stopPropagation();var t=e(this).closest("li"),a=t.closest(".messages-stack"),i=a.closest(".bp-messages-threads-wrapper"),r=t.attr("data-id"),n=a.find(".content .info .name a").text(),o="",l="",d=t.find(".bpbm-replied-message-reply");d.length>0?o+=d.text():o+=t.find(".message-content").text();var c=t.find(".message-content > [data-desc]");c.length>0&&c.each(function(){var s=e(this).attr("data-desc");void 0!==s&&(l+='<span class="bpbm-preview-desc">'+atob(s)+"</span>")});var p='<div class="bpbm-preview-message bpbm-reply-message" style="display:none" data-message-id="'+r+'"><div class="bpbm-preview-message-cancel"><i class="far fa-times-circle"></i></div><div class="bpbm-preview-message-content"><span class="bpbm-preview-message-name"></span><div class="bpbm-preview-message-text"></div></div></div>',m=i.find(".bpbm-preview-message");m.length>0?(m=m.replaceWith(p),(m=i.find(".bpbm-preview-message")).show(),M()):(m=e(p).insertBefore(i.find(".reply"))).slideDown(100,function(){M()}),m.find(".bpbm-preview-message-name").text(n),m.find(".bpbm-preview-message-text").text(o),m.find(".bpbm-preview-message-text").append(l),m.find(".bpbm-gifs-icon").html(X.gif)}),L.on("click",".bpbm-preview-message-cancel",function(s){s.preventDefault(),s.stopPropagation();var t=e(this).closest(".bpbm-preview-message");t.slideUp(100,function(){t.remove(),M()})});var C,k=!1,y="";L.on("submit",".reply > form",function(s){if(s.preventDefault(),s.stopImmediatePropagation(),ifvisible.focus(),!0!==k){var a=e(this);if(a.serialize()===y)return!1;var i=t(e(this).find('textarea[name="message"]')),r=e(this).serialize();e(this).find("textarea, .bp-emojionearea-editor").html("").val("");var n=a.find('input[name="thread_id"]').val(),o=!1,l=!1,d=e(this).parent().parent(),c=d.find(".thread.scroller[data-users-json]"),p=d.find(".bpbm-preview-message.bpbm-reply-message");p.length>0&&(l=!0,r+="&reply=1&message_id="+parseInt(p.attr("data-message-id")));var m=d.find(".bpbm-preview-message.bpbm-edit-message");m.length>0&&(o=!0,r+="&edit=1&message_id="+parseInt(m.attr("data-message-id")));var g=atob(c.attr("data-users-json"));Object.keys(e.parseJSON(g));e(this).closest(".bp-better-messages-mini").length>0&&(n=e(this).closest(".chat").attr("data-thread"));var b="1"===BP_Messages.realtime;if(!1!==F&&F.some(function(e){return i.indexOf(e)>=0})&&(b=!1),"1"===BP_Messages.encryption){var f=c.data("secret");i=BPBMAES256.encrypt(i,f)}n&&b&&!o&&!l?U.emit("fast_message",n,i,"",function(s){y=r,clearInterval(C),C=setInterval(function(){y=""},3e3),e(document).trigger("bp-better-messages-message-sent"),void 0!==K.sent&&K.sent.play(),h('.bp-messages-wrap[data-thread-id="'+n+'"]'),h('.bp-better-messages-mini .chats .chat[data-thread="'+n+'"]'),r+="&tempID="+s,e.post(BP_Messages.ajaxUrl,r,function(s){if(void 0!==s.result&&(e.each(s.errors,function(){BBPMShowError(this)}),void 0!==s.redirect&&"refresh"===s.redirect)){a.closest(".bp-messages-wrap").hasClass("bp-better-messages-mini")?(e('.bp-better-messages-mini .chats .chat[data-thread="'+n+'"]').remove(),openMiniChat(n,!0)):v(location.href,a.closest(".bp-messages-wrap"))}}).always(function(){k=!1})}):e.post(BP_Messages.ajaxUrl,r,function(s){void 0!==s.result&&(!1!==s.result?(u(),e(document).trigger("bp-better-messages-message-sent"),o||(void 0!==K.sent&&K.sent.play(),h('.bp-messages-wrap[data-thread-id="'+n+'"]'),h('.bp-better-messages-mini .chats .chat[data-thread="'+n+'"]')),y=r,clearInterval(C),C=setInterval(function(){y=""},3e3),l&&p.find(".bpbm-preview-message-cancel").click(),o&&(m.find(".bpbm-preview-message-cancel").click(),"1"!=BP_Messages.realtime&&v(location.href,a.closest(".bp-messages-wrap")))):(e.each(s.errors,function(){BBPMShowError(this)}),void 0!==s.redirect&&"refresh"===s.redirect&&v(location.href,a.closest(".bp-messages-wrap"))))}).always(function(){k=!1}),e(document).trigger("bp-better-messages-message-sent-end")}}),L.on("click ",".bpbm-stickers-selector .bpbm-stickers-selector-sticker",function(s){s.preventDefault(),s.stopPropagation();var t=e(this),a=t.closest(".bpbm-stickers-selector"),i=a.parent().find(".reply form"),r=t.data("sticker-id"),o=t.find("img").attr("src"),l=i.find('input[name="thread_id"]').val(),d=i.find('input[name="_wpnonce"]').val();a.hide(),n(),e.post(BP_Messages.ajaxUrl,{action:"bpbm_messages_send_sticker",thread_id:l,sticker_id:r,sticker_img:o,_wpnonce:d},function(e){})}),L.on("click ",".bpbm-gifs-selector .bpbm-gifs-selector-gif",function(s){s.preventDefault(),s.stopPropagation();var t=e(this),a=t.closest(".bpbm-gifs-selector"),i=a.parent().find(".reply form"),r=t.data("gif-id"),o=i.find('input[name="thread_id"]').val(),l=i.find('input[name="_wpnonce"]').val();a.hide(),n(),e.post(BP_Messages.ajaxUrl,{action:"bpbm_messages_send_gif",thread_id:o,gif_id:r,_wpnonce:l},function(e){})}),L.on("click touchstart",".reply .bpbm-stickers-btn",function(s){s.preventDefault(),s.stopPropagation();var t=e(this).closest(".reply"),a=t.parent(),i=t.find("form").find("textarea"),r=a.find(".bpbm-stickers-selector");i.blur(),r.is(":visible")||r.show()}),L.on("click touchstart",".reply .bpbm-gifs-btn",function(s){s.preventDefault(),s.stopPropagation();var t=e(this).closest(".reply"),a=t.parent(),i=t.find("form").find("textarea"),r=a.find(".bpbm-gifs-selector");i.blur(),r.is(":visible")||(r.show(),r.find('.bpbm-gifs-tabs span[data-package-id="trending"]').click())}),L.on("click",".bpbm-gifs-selector .bpbm-gifs-close",function(s){s.preventDefault(),s.stopPropagation();var t=e(this).closest(".bpbm-gifs-selector");t.hide(),t.find(".bpbm-gifs-tabs .bpbm-gifs-tabs-active").removeClass("bpbm-gifs-tabs-active"),t.find(".bpbm-gifs-selector-gif-list").html("")}),L.on("click",".bpbm-gifs-selector .bpbm-gifs-head .bpbm-gifs-tabs span",function(s){s.preventDefault(),s.stopPropagation();var t=e(this),a=t.closest(".bpbm-gifs-selector"),i=a.find(".bpbm-gifs-selector-gif-container");if(!t.hasClass("bpbm-gifs-tabs-active")){a.find(".bpbm-gifs-tabs span").removeClass("bpbm-gifs-tabs-active"),t.addClass("bpbm-gifs-tabs-active"),i.html(W);var r=t.data("package-id");e.post(BP_Messages.ajaxUrl,{action:"bpbm_messages_get_gif_tab",package:r},function(s){if(i.html(s),"trending"===r){i.on("scroll",function(s){s.stopImmediatePropagation();var t=e(s.currentTarget),a=t.outerHeight()+150;if(t[0].scrollHeight-t.scrollTop()<=a){var n=i.find(".bpbm-gifs-selector-gif-list");if(!n.hasClass("bpbm-loading-gifs")){var o=n.data("pages"),l=n.data("pages-loaded")+1;l<o&&(n.addClass("bpbm-loading-gifs"),x=e.post(BP_Messages.ajaxUrl,{action:"bpbm_messages_get_gif_tab",package:r,page:l},function(s){n.data("pages-loaded",l),e(s).appendTo(n),n.removeClass("bpbm-loading-gifs")}))}}})}})}}),L.on("click",".bpbm-stickers-selector .bpbm-stickers-close",function(s){s.preventDefault(),s.stopPropagation();var t=e(this).closest(".bpbm-stickers-selector");t.parent();t.hide()}),L.on("click",".bpbm-stickers-selector .bpbm-stickers-head .bpbm-stickers-tabs span",function(s){s.preventDefault(),s.stopPropagation();var t=e(this),a=t.closest(".bpbm-stickers-selector"),i=a.find(".bpbm-stickers-selector-sticker-container");a.find(".bpbm-stickers-tabs span").removeClass("bpbm-stickers-tabs-active"),t.addClass("bpbm-stickers-tabs-active"),i.html(W);var r=t.data("package-id");e.post(BP_Messages.ajaxUrl,{action:"bpbm_messages_get_sticker_tab",package:r},function(e){i.html(e)})});var x;L.on("keyup change",'.bpbm-gifs-tabs input[name="search"]',function(s){s.preventDefault(),s.stopPropagation();var t=e(this),a=t.closest(".bpbm-gifs-selector"),i=a.find(".bpbm-gifs-selector-gif-container"),r=a.find(".bpbm-gifs-selector-gif-list"),n=t.data("search-term"),o=t.val();if(n!==o){t.data("search-term",o),x&&x.abort();r.addClass("bpbm-loading-gifs"),x=e.post(BP_Messages.ajaxUrl,{action:"bpbm_messages_search_gifs",search:o},function(s){r.replaceWith(s),i.on("scroll",function(s){s.stopImmediatePropagation();var t=e(s.currentTarget),i=t.outerHeight()+150;if(t[0].scrollHeight-t.scrollTop()<=i&&!(r=a.find(".bpbm-gifs-selector-gif-list")).hasClass("bpbm-loading-gifs")){var n=r.data("pages"),l=r.data("pages-loaded")+1;l<n&&(r.addClass("bpbm-loading-gifs"),x=e.post(BP_Messages.ajaxUrl,{action:"bpbm_messages_search_gifs",search:o,page:l},function(s){r.data("pages-loaded",l),e(s).appendTo(r),r.removeClass("bpbm-loading-gifs")}))}})})}});var D;L.on("keyup change",".bpbm-stickers-selector .bpbm-stickers-search input",function(s){s.preventDefault(),s.stopPropagation();var t=e(this),a=t.closest(".bpbm-stickers-search"),i=t.closest(".bpbm-stickers-selector"),r=i.find(".bpbm-stickers-selector-sticker-list"),n=a.data("search-term"),o=t.val();n!==o&&(a.data("search-term",o),D&&D.abort(),D=e.post(BP_Messages.ajaxUrl,{action:"bpbm_messages_search_stickers",search:o},function(s){r.replaceWith(s),(r=i.find(".bpbm-stickers-selector-sticker-list")).BPBMoverlayScrollbars({sizeAutoCapable:!1,callbacks:{onScroll:function(s){var t=this.scroll(),a=t.position.y;if(t.max.y-a<=10){var i=this.getElements(),r=BPBMJQ(i.host);if(!r.hasClass("bpbm-loading-stickers")){var n=r.data("pages"),l=r.data("pages-loaded")+1;l<=n&&(r.addClass("bpbm-loading-stickers"),e.post(BP_Messages.ajaxUrl,{action:"bpbm_messages_search_stickers",search:o,page:l},function(s){r.data("pages-loaded",l),e(s).appendTo(BPBMJQ(i.content)),r.removeClass("bpbm-loading-stickers")}))}}}}})}))}),L.on("submit",".new-message form",function(s){s.preventDefault(),s.stopPropagation();var a=BPBMJQ(s.target).closest(".bp-messages-wrap");j(a);t(e(this).find('textarea[name="message"]'));var i=e(this),r=i.serialize();e(document).trigger("bp-better-messages-new-thread-start"),e.post(BP_Messages.ajaxUrl,r,function(s){s.result?(e(document).trigger("bp-better-messages-new-thread-created"),v(BP_Messages.threadUrl+s.result,a)):(e(document).trigger("bp-better-messages-new-thread-error"),i.closest(".bp-messages-wrap").find(".preloader").hide(),e.each(s.errors,function(){BBPMShowError(this)})),e(document).trigger("bp-better-messages-new-thread-end")}).fail(function(){i.closest(".bp-messages-wrap").find(".preloader").hide(),e(document).trigger("bp-better-messages-new-thread-end")})}),L.on("click","a.ajax",function(s){s.preventDefault(),s.stopPropagation();v(e(this).attr("href"),e(this).closest(".bp-messages-wrap"))}),L.on("click",".bpbm-search a.search",function(s){s.preventDefault(),s.stopPropagation(),e(this).hide(),e(".bpbm-search form").show(),e(".bpbm-search form input").trigger("focus"),V&&e(".bp-messages-wrap .chat-header .settings").hide()}),L.on("click",".bpbm-search form span.close",function(s){s.preventDefault(),s.stopPropagation();var t=e(this).closest(".bpbm-search"),a=t.find("form input");t.closest(".bp-messages-side-threads").length>0?(a.val(""),a.trigger("change"),t.find("form .close").hide()):(t.find("form").hide(),t.find("a.search").show(),a.val(""))}),L.on("submit",".bpbm-search form",function(s){s.preventDefault();var t=e(this).closest(".bp-messages-wrap");v(BP_Messages.url+urlSeparator+e(this).serialize(),t)}),!1===("1"===BP_Messages.disableEnterForTouch&&V||"1"===BP_Messages.disableEnterForDesktop&&!V)&&(L.on("keydown",".reply .bp-emojionearea-editor",function(s){s.shiftKey||13!=s.keyCode||(s.preventDefault(),s.stopImmediatePropagation(),e(this).trigger("blur"),e(this).parent().parent().trigger("submit"),e(this).trigger("focus"))}),L.on("keyup",".reply .bp-emojionearea-editor",function(e){e.shiftKey||13!=e.keyCode||(e.preventDefault(),e.stopImmediatePropagation())})),L.on("change",".new-message .send-to-input",function(s){s.preventDefault(),s.stopPropagation();v(e(this).attr("href"),e(this).closest(".bp-messages-wrap"))}),V?L.on("touchend",".scroller.starred .messages-list li, .scroller.search .messages-list li",function(s){if(1!=p&&!1===m){s.preventDefault(),s.stopPropagation();var t=e(this).attr("data-thread"),a=e(this).attr("data-id");v(BP_Messages.threadUrl+t+"&message_id="+a,e(this).closest(".bp-messages-wrap"))}}).on("touchmove",function(e){p=!0}).on("touchstart",function(e){p=!1}):L.on("click",".scroller.starred .messages-list li, .scroller.search .messages-list li",function(s){s.preventDefault(),s.stopPropagation();var t=e(this).attr("data-thread"),a=e(this).attr("data-id");v(BP_Messages.threadUrl+t+"&message_id="+a,e(this).closest(".bp-messages-wrap"))}),L.on("click",".participants-panel .bp-messages-user-list .user .actions a.remove-from-thread",function(s){s.preventDefault();var t=e(this).closest(".bp-messages-wrap"),a=e(this).parent().parent(),i=a.data("id"),r=a.data("thread-id"),n=a.find(".name").text(),o=BP_Messages.strings.exclude;t.hasClass("bp-messages-wrap-chat")&&(o=BP_Messages.strings.exclude_chat),o=o.replace("%s",n);confirm(o)&&e.post(BP_Messages.ajaxUrl,{action:"bp_better_messages_exclude_user_from_thread",user_id:i,thread_id:r,nonce:BP_Messages.userNonce},function(s){if(!0===s.result){v(BP_Messages.url+urlSeparator+e.param({thread_id:r,participants:"1"}),t)}})}),L.on("click",".bpbm-mute-thread",function(s){s.preventDefault();var t,a=e(this).closest(".bp-messages-wrap"),i=e(this).closest(".bp-better-messages-mini").length>0,r=location.href;if(i?t=e(this).closest(".chat").attr("data-thread"):(t=a.attr("data-thread-id"),a.is("#bp-better-messages-mini-mobile-container")&&(t=a.attr("data-thread"),r=BP_Messages.baseUrl+"?thread_id="+t)),void 0===t)return!1;-1===r.indexOf("?thread_id=")&&(r=BP_Messages.baseUrl+"?thread_id="+t);confirm(BP_Messages.strings.mute_thread)&&(j(i?e(this).closest(".chat"):a),e.post(BP_Messages.ajaxUrl,{action:"bp_messages_mute_thread",thread_id:t,nonce:BP_Messages.userNonce},function(s){i?openMiniChat(t,!0,!0):v(r,a);e(G+'[data-id="'+t+'"] .bpbm-counter-row').prepend('<span class="bpbm-thread-muted"><i class="fas fa-bell-slash"></i></span>'),BP_Messages.mutedThreads[t]=Date.now()}).always(function(){}))}),L.on("click",".bpbm-block-user",function(s){s.preventDefault();var t,a=e(this).closest(".bp-messages-wrap"),i=e(this).closest(".bp-better-messages-mini").length>0,r=location.href,n=parseInt(e(this).attr("data-user-id"));if(i?t=e(this).closest(".chat").attr("data-thread"):(t=a.attr("data-thread-id"),a.is("#bp-better-messages-mini-mobile-container")&&(t=a.attr("data-thread"),r=BP_Messages.baseUrl+"?thread_id="+t)),void 0===t)return!1;-1===r.indexOf("?thread_id=")&&(r=BP_Messages.baseUrl+"?thread_id="+t);confirm(BP_Messages.strings.user_block)&&(j(i?e(this).closest(".chat"):a),e.post(BP_Messages.ajaxUrl,{action:"bp_messages_block_user",user_id:n,nonce:BP_Messages.userNonce},function(e){i?openMiniChat(t,!0,!0):v(r,a)}).always(function(){}))}),L.on("click",".bpbm-unblock-user",function(s){s.preventDefault();var t,a=e(this).closest(".bp-messages-wrap"),i=e(this).closest(".bp-better-messages-mini").length>0,r=location.href,n=parseInt(e(this).attr("data-user-id"));if(i?t=e(this).closest(".chat").attr("data-thread"):(t=a.attr("data-thread-id"),a.is("#bp-better-messages-mini-mobile-container")&&(t=a.attr("data-thread"),r=BP_Messages.baseUrl+"?thread_id="+t)),void 0===t)return!1;-1===r.indexOf("?thread_id=")&&(r=BP_Messages.baseUrl+"?thread_id="+t);confirm(BP_Messages.strings.user_unblock)&&(j(i?e(this).closest(".chat"):a),e.post(BP_Messages.ajaxUrl,{action:"bp_messages_unblock_user",user_id:n,nonce:BP_Messages.userNonce},function(e){i?openMiniChat(t,!0,!0):v(r,a)}).always(function(){}))}),L.on("click",".bpbm-leave-thread",function(s){s.preventDefault();var t,a=e(this).closest(".bp-messages-wrap"),i=e(this).closest(".bp-better-messages-mini").length>0;location.href;if(i?t=e(this).closest(".chat").attr("data-thread"):(t=a.attr("data-thread-id"),a.is("#bp-better-messages-mini-mobile-container")&&(t=a.attr("data-thread"),BP_Messages.baseUrl+"?thread_id="+t)),void 0===t)return!1;confirm(BP_Messages.strings.leave_thread)&&(j(i?e(this).closest(".chat"):a),e.post(BP_Messages.ajaxUrl,{action:"bp_messages_leave_thread",thread_id:t,nonce:BP_Messages.userNonce},function(s){s?(void 0!==U&&U.emit("threadOpen",t),e(G+'[data-id="'+t+'"]').remove(),i?e('.bp-better-messages-mini .chats .chat[data-thread="'+t+'"] > .head .close').click():v(BP_Messages.baseUrl,a)):a.find(".preloader").hide()}))}),L.on("click",".bpbm-delete-thread",function(s){s.preventDefault();var t,a=e(this).closest(".bp-messages-wrap"),i=e(this).closest(".bp-better-messages-mini").length>0,r=location.href;if(i?t=e(this).closest(".chat").attr("data-thread"):(t=a.attr("data-thread-id"),a.is("#bp-better-messages-mini-mobile-container")&&(t=a.attr("data-thread"),r=BP_Messages.baseUrl)),void 0===t)return!1;-1===r.indexOf("?thread_id=")&&(r=BP_Messages.baseUrl);confirm(BP_Messages.strings.delete_thread)&&(j(i?e(this).closest(".chat"):a),e.post(BP_Messages.ajaxUrl,{action:"bp_messages_erase_thread",thread_id:t,_wpnonce:BP_Messages.userNonce},function(s){e('.bp-messages-wrap .threads-list .thread[data-id="'+t+'"]').remove(),e('.bp-better-messages-mini .chats .chat[data-thread="'+t+'"] .head span.close').click(),i||v(r,a)}).always(function(){}))}),L.on("click",".bpbm-clear-thread",function(s){s.preventDefault();var t,a=e(this).closest(".bp-messages-wrap"),i=a.hasClass("bp-messages-wrap-chat"),r=a.hasClass("bp-messages-group-thread"),n=e(this).closest(".bp-better-messages-mini").length>0,o=location.href;if(n?t=e(this).closest(".chat").attr("data-thread"):(t=a.attr("data-thread-id"),a.is("#bp-better-messages-mini-mobile-container")&&(t=a.attr("data-thread"),o=BP_Messages.baseUrl)),void 0===t)return!1;-1===o.indexOf("?thread_id=")&&(o=BP_Messages.baseUrl),(i||r)&&(o=BP_Messages.baseUrl+"?thread_id="+t);confirm(BP_Messages.strings.clear_chat_thread)&&(j(n?e(this).closest(".chat"):a),e.post(BP_Messages.ajaxUrl,{action:"bp_messages_clear_thread",thread_id:t,_wpnonce:BP_Messages.userNonce},function(e){n?openMiniChat(t,!0,!0):v(o,a)}).always(function(){}))}),L.on("click",".chat-header .bpbm-invite-thread",function(s){s.preventDefault();var t=e(this).closest(".bp-messages-wrap"),a=t.find(".add-user-panel"),i=t.find(".scroller.thread"),r=t.find(".participants-panel");a.hasClass("open")||(a.addClass("open"),r.removeClass("open"),i.hide())}),L.on("click",".chat-header .participants",function(s){s.preventDefault();var t=e(this).closest(".bp-messages-wrap"),a=t.find(".participants-panel"),i=t.find(".scroller.thread"),r=t.find(".add-user-panel"),n=parseInt(t.attr("data-thread-id"));isNaN(n)&&(n=parseInt(t.attr("data-thread"))),a.hasClass("participants-loaded")||(a.addClass("participants-loaded"),e.post(BP_Messages.ajaxUrl,{action:"bp_messages_load_thread_participants",thread_id:n},function(e){a.find(".bp-messages-user-list").html(e)}).always(function(){})),a.hasClass("open")?(a.removeClass("open"),i.show()):(a.addClass("open"),r.removeClass("open"),i.hide())}),L.on("click",".bpbm-unmute-thread",function(s){s.preventDefault();var t,a=e(this).closest(".bp-messages-wrap"),i=e(this).closest(".bp-better-messages-mini").length>0,r=location.href;i?t=e(this).closest(".chat").attr("data-thread"):(t=a.attr("data-thread-id"),a.is("#bp-better-messages-mini-mobile-container")&&(t=a.attr("data-thread"),r=BP_Messages.baseUrl+"?thread_id="+t));confirm(BP_Messages.strings.unmute_thread)&&(j(i?e(this).closest(".chat"):a),e.post(BP_Messages.ajaxUrl,{action:"bp_messages_unmute_thread",thread_id:t,nonce:BP_Messages.userNonce},function(s){void 0!==BP_Messages.mutedThreads[t]&&delete BP_Messages.mutedThreads[t],e(G+'[data-id="'+t+'"] .bpbm-counter-row .bpbm-thread-muted').remove(),i?openMiniChat(t,!0,!0):v(r,a)}).always(function(){}))}),L.on("click",'.add-user button[type="submit"]',function(s){s.preventDefault();var t=e(this).closest(".bp-messages-wrap"),a=e(this).closest(".add-user"),i=a.data("thread-id"),r=[];a.find('input[name="recipients[]"]').each(function(){r.push(e(this).val())}),j(t),e.post(BP_Messages.ajaxUrl,{action:"bp_better_messages_add_user_to_thread",users:r,thread_id:i,nonce:BP_Messages.userNonce},function(s){v(BP_Messages.url+urlSeparator+e.param({thread_id:i,participants:"1"}),t)})}),L.on("click",".add-user button.bpbm-close",function(s){s.preventDefault();var t=e(this).closest(".bp-messages-wrap"),a=t.find(".add-user-panel"),i=t.find(".scroller.thread");a.hasClass("open")&&(a.removeClass("open"),i.show())}),L.on("click",".bpbm-join-to-chat-button",function(s){s.preventDefault();var t=e(this).closest(".bp-messages-wrap"),a=t.data("chat-id"),i=t.data("thread-id");j(t),e.post(BP_Messages.ajaxUrl,{action:"bp_better_messages_join_chat",chat_id:a,nonce:BP_Messages.userNonce},function(s){v(BP_Messages.url+urlSeparator+e.param({thread_id:i}),t)})}),L.on("click",".bpbm-leave-chat-room",function(s){s.preventDefault();var t=e(this).closest(".bp-messages-wrap"),a=t.data("chat-id"),i=t.data("thread-id");j(t),e.post(BP_Messages.ajaxUrl,{action:"bp_better_messages_leave_chat",chat_id:a,nonce:BP_Messages.userNonce},function(s){v(BP_Messages.url+urlSeparator+e.param({thread_id:i}),t)})}),e(document).on("click",".bm-threads-list .threads-list .thread:not(.blocked)",function(s){s.preventDefault();var t=e(this),a=t.data("id");if("1"==BP_Messages.miniChats){var i=t.parent().parent(),r=e(t).height(),n=t.position().top;n+=i.scrollTop(),t.addClass("blocked loading"),e(t).find(".loading").css({height:r,"line-height":r+"px",top:n+"px"}),openMiniChat(a,!0).always(function(e){l(),t.removeClass("blocked loading")})}else{var o=BP_Messages.threadUrl+a+"&scrollToContainer";if(V){var d=e("#bp-better-messages-mini-mobile-open");if(d.length>0){var c=BP_Messages.baseUrl;BP_Messages.baseUrl=BP_Messages.threadUrl+a,d.click(),BP_Messages.baseUrl=c}else location.href=o}else{var p=e(".bp-messages-wrap.bp-messages-wrap-main");p.length>0?v(o,p):location.href=o}}}),e(document).on("click",".bp-messages-wrap .chat-tabs > div",function(s){s.preventDefault();var t=e(this),a=t.closest(".chat-tabs"),i=a.parent(),r=t.data("tab");if(!e(this).hasClass("active")){a.find("> div").removeClass("active"),t.addClass("active"),a.find("> div").each(function(){var s=e(this).data("tab");i.find("."+s).hide()});!function(s){s.hasClass("bpbm-friends-list")&&(s.hasClass("bpbm-loaded")||(s.addClass("bpbm-loaded"),e.post(BP_Messages.ajaxUrl,{action:"bp_messages_load_friends_list",nonce:BP_Messages.userNonce},function(e){s.html(e),_(),B()}))),s.hasClass("bpbm-groups-list")&&(s.hasClass("bpbm-loaded")||(s.addClass("bpbm-loaded"),e.post(BP_Messages.ajaxUrl,{action:"bp_messages_load_groups_list",nonce:BP_Messages.userNonce},function(e){s.html(e)}))),s.show()}(i.find("."+r))}}),e(document).on("click",".bp-better-messages-list .tabs > div",function(s){s.preventDefault();var t=e(this).data("tab");"bpbm-close"===t?(e(".bp-better-messages-list .tabs > div, .bp-better-messages-list .tabs-content > div").removeClass("active"),e('.bp-better-messages-list .tabs > div[data-tab="bpbm-close"]').hide(),J=!1):e(this).hasClass("active")?(e(this).removeClass("active"),e(".bp-better-messages-list .tabs-content ."+t).removeClass("active"),e('.bp-better-messages-list .tabs > div[data-tab="bpbm-close"]').hide(),J=!1):(e(".bp-better-messages-list .tabs > div, .bp-better-messages-list .tabs-content > div").removeClass("active"),e(this).addClass("active"),e(".bp-better-messages-list .tabs-content ."+t).addClass("active"),J=t,e('.bp-better-messages-list .tabs > div[data-tab="bpbm-close"]').show()),store.set("bp-better-messages-mini-messages",J)}),e(document).on("click",".bpbm-deleted-user-link",function(e){e.preventDefault()}),e(document).on("click",".bp-better-messages-list .new-message",function(s){var t=e(".bp-messages-wrap.bp-messages-wrap-main");t.length>0&&(s.preventDefault(),v(e(this).attr("href"),t))}),e(document).on("click",".bp-messages-group-list .group:not(.blocked)",function(s){if(e(s.target).is("div")){s.preventDefault();var t=e(this);if(t.hasClass("bpbm-messages-disabled"))location.href=t.find(".open-group").attr("href");else{var a=t.closest(".bp-messages-column").length>0||t.closest(".bp-messages-side-threads").length>0,i=(t.data("group-id"),t.data("thread-id")),r=t.find(".actions .open-group").attr("href");"1"===BP_Messages.enableGroups&&(r+=BP_Messages.groupsSlug+"/?scrollToContainer");var n=t.parent().parent(),o=t.height(),l=t.position().top;if(l+=n.scrollTop(),t.find(".loading").css({height:o,"line-height":o+"px",top:l+"px"}),a){var d=t.closest(".bp-messages-wrap");d.length>0&&v(BP_Messages.threadUrl+i,d)}else"1"===BP_Messages.enableGroups&&"1"==BP_Messages.miniChats&&i?(t.addClass("blocked loading"),openMiniChat(i,!0).always(function(e){t.removeClass("blocked loading")})):(t.addClass("blocked loading"),location.href=r)}}}),e(document).on("click",".bp-messages-user-list .user:not(.blocked)",function(s){if(e(s.target).is("div")){s.preventDefault();var t=e(this),a=e(this).data("id"),i=e(this).data("username");if(t.closest(".bp-messages-column").length>0||t.closest(".bp-messages-side-threads").length>0){l=BP_Messages.url+urlSeparator+"new-message&to="+i;"1"==BP_Messages.fastStart&&(l+="&fast=1");(d=t.closest(".bp-messages-wrap")).length>0&&v(l,d)}else if("1"==BP_Messages.miniChats&&"1"==BP_Messages.fastStart){var r=t.parent().parent(),n=e(t).height(),o=t.position().top;o+=r.scrollTop(),e(t).find(".loading").css({height:n,"line-height":n+"px",top:o+"px"}),t.addClass("blocked loading"),openPrivateThread(a).always(function(e){t.removeClass("blocked loading")})}else{var l=BP_Messages.url+urlSeparator+"new-message&to="+i;"1"==BP_Messages.fastStart&&(l+="&fast=1&scrollToContainer");var d=e(".bp-messages-wrap.bp-messages-wrap-main");d.length>0?v(l,d):location.href=l}}}),e(document).on("click",".bp-messages-wrap .bpbm-user-me",function(s){s.preventDefault(),e(this).toggleClass("bpbm-open")}),e(document).on("click",".bp-messages-wrap .bpbm-user-me .bpbm-user-me-popup .bpbm-user-me-popup-list-item",function(s){s.stopImmediatePropagation();e(this).is("a")||s.preventDefault()})}function n(){e.each(L,function(s,t){var a=e(t);if(a.hasClass("bp-messages-wrap-main")){var i=a.find("> .bp-messages-threads-wrapper .bp-messages-side-threads");if(i.length>0){var r=i.closest(".bp-messages-threads-wrapper"),n=2*i.width();n<800&&(n=800),a.width()<n?(r.addClass("threads-hidden"),i.hide()):(r.removeClass("threads-hidden"),i.show())}}if(a.hasClass("bp-messages-mobile")){var o=window.innerHeight,l=0;l+=a.find(".chat-header").outerHeight(),a.find(".chat-footer:visible").length>0&&(l+=a.find(".chat-footer:visible").outerHeight()),a.find(".reply").length>0&&(l+=a.find(".reply").outerHeight()),a.find(".scroller").css({height:o-l})}else!function(){var s=e(window).height()-50,t=e("#wpadminbar");t.length>0&&t.is(":visible")&&(s-=t.height());var a=s,i=BP_Messages.min_height;s>BP_Messages.max_height&&(s=BP_Messages.max_height),BP_Messages.fixedHeaderHeight>0&&(s-=BP_Messages.fixedHeaderHeight),(s=parseInt(s))<i&&(s=i),BPBMJQ(".bp-messages-wrap .scroller").each(function(){var t=e(this),i=t.closest(".bp-messages-column"),r=t.closest(".bp-messages-wrap");if(r.hasClass("bp-better-messages-mini")){var n=BP_Messages.miniChatsHeight,o=r.find(".reply").outerHeight();n>a&&(n=a-o-10),t.css("max-height",n),t.css("height",n)}else if(r.hasClass("bp-better-messages-list")){var l=BP_Messages.miniWindowsHeight;if(l>a){l=a-10;var d=t.closest(".messages");if(d.length>0){var c=d.find(".chat-header");c.length>0&&(l-=c.outerHeight())}}t.css("max-height",l),t.css("height",l)}else if(i.length>0&&i.parent().find(".bp-messages-side-threads").is(":visible"))(p=t.closest(".bp-messages-threads-wrapper")).css("max-height",s),p.css("height",s);else{var p=t.closest(".bp-messages-threads-wrapper");p.css("max-height",s),p.css("height",s)}}),BPBMJQ(".bp-messages-wrap.bp-better-messages-list .scroller").css("max-height",s-50),BPBMJQ(".bp-messages-wrap.bp-better-messages-mini .scroller").css("max-height",s-50)}()})}function o(e){}function l(){function t(s){e(s).BPemojioneArea({tones:!0,tonesStyle:"bullet",saveEmojisAs:"unicode",autocomplete:!1,stayFocused:!1,attributes:{dir:r}}).each(function(){function s(){if(!0===a)return!1;if(t.next(".bp-emojionearea").length>0){a=!0,n();var i=new BPBM_MediumEditor(document.querySelectorAll(".bp-emojionearea-editor"),{toolbar:{allowMultiParagraphSelection:!1,buttons:["bold","italic","underline","strikethrough","subscript","superscript","removeFormat"],diffLeft:0,diffTop:-10,firstButtonClass:"medium-editor-button-first",lastButtonClass:"medium-editor-button-last",relativeContainer:null,standardizeSelectionStart:!1,static:!1,align:"center",sticky:!1,updateOnEmptySelection:!0},placeholder:!1,imageDragging:!1});i.subscribe("editableInput",function(s,t){var a=e(t);a.hasClass("bpbm-interacted")||setTimeout(function(){a.addClass("bpbm-interacted")},100)}),i.subscribe("editablePaste",function(s,t){var a=e(t).closest(".reply");if(a.find("form > .message").hasClass("file-uploader-enabled")){var i=[];if(function(e,s){for(var t=[],a=(s=s||0)||0;a<e.length;a++)t[a-s]=e[a];return t}(event.clipboardData.items).forEach(function(e){if("file"===e.kind){var s=e.getAsFile();s&&i.push({name:e.name,type:e.type,data:s})}}),i.length>0){var r=a.find('input[name="thread_id"]').val();a.find(".upload-btn").click();var n=e("body > .uppy.uppy-thread-"+r);n.length>0&&(n=n[0].uppy,i.forEach(function(e){var s={source:n.id,type:e.type,data:e.data};void 0!==e.name&&"undefined"!==e.name?s.name=e.name:s.name="",n.addFile(s).catch(function(){})}))}}}),e(t).html("<p></p>")}else setTimeout(s,333)}var t=e(this);if(void 0!==t[0]){t.closest("form").addClass("bp-emoji-enabled");var a=!1;try{t[0].BPemojioneArea.on("onLoad",function(){s()})}catch(e){}setTimeout(s,333)}})}function i(s,t){void 0===t&&(t=!1);var a=e(s);if(a.hasClass("loading-more")||a.hasClass("all-loaded"))return!1;a.addClass("loading-more"),a.find(".loading-messages").show();var r=[],n=a.find(".loading-messages");a.find(".threads-list > .thread").each(function(){r.push(e(this).data("id"))});var o={action:"bp_messages_get_more_threads",loaded_threads:r,user_id:BP_Messages.displayed_user_id};a.closest(".bp-messages-wrap").hasClass("bp-better-messages-list")&&(o.user_id=BP_Messages.user_id),e.post(BP_Messages.ajaxUrl,o,function(r){e(r).insertBefore(n),a.removeClass("loading-more"),a.find(".loading-messages").hide(),""===r.trim()?a.addClass("all-loaded"):t&&Math.ceil(s.get(0).scrollHeight)<=Math.ceil(s.innerHeight())&&i(s,!0)})}T=!1,S=!1,H=!0,clearTimeout(D),"1"!==BP_Messages.realtime&&s(BP_Messages.total_unread),document.dispatchEvent(new BPBMEvent("bp-better-messages-reinit-start")),f(),_(),e(".bp-messages-wrap:not(.bp-better-messages-mini,.bp-better-messages-list) .thread.scroller[data-users-json]").length>0?T=e(".bp-messages-wrap:not(.bp-better-messages-mini,.bp-better-messages-list) .thread.scroller[data-users-json]").attr("data-id"):e(".bp-messages-wrap:not(.bp-better-messages-mini,.bp-better-messages-list,#bp-better-messages-mini-mobile-container) .threads-list").length>0&&(S=!0),D=T?setTimeout(u,BP_Messages.threadRefresh):setTimeout(b,BP_Messages.siteRefresh);var r="ltr";O&&(r="rtl");if("1"===BP_Messages.mobileEmojiEnable||!V&&!e("body").hasClass("bp-messages-mobile")){t(l=".bp-messages-wrap .reply .message textarea, .bp-messages-wrap .new-message #message-input, .bp-messages-wrap .bulk-message #message-input")}else{var l=".bp-better-messages-mini .chats .chat .reply .message textarea";t(l),e.fn.BPBMloadEmojione(123),n()}if("function"==typeof e.fn.BPBMoverlayScrollbars&&(e(document).on("bp-better-messages-init-scrollers",function(){BPBMJQ(".bp-better-messages-list .tabs-content .friends .scroller,.bp-better-messages-list .tabs-content .bpbm-groups .scroller,.scroller.search, .scroller.starred").BPBMoverlayScrollbars({sizeAutoCapable:!1,overflowBehavior:{x:"hidden"}}),BPBMJQ(".bpbm-users-avatars-list").BPBMoverlayScrollbars({sizeAutoCapable:!0,overflowBehavior:{x:"scroll",y:"hidden"},scrollbars:{clickScrolling:!0,autoHide:"leave"}}),BPBMJQ(".bpbm-stickers-selector .bpbm-stickers-head .bpbm-stickers-tabs").BPBMoverlayScrollbars({sizeAutoCapable:!1,overflowBehavior:{y:"hidden"}});var s=!1;BPBMJQ(".scroller.thread").BPBMoverlayScrollbars({sizeAutoCapable:!1,autoUpdate:!0,overflowBehavior:{x:"hidden"},callbacks:{onInitialized:function(){var s=this.getElements(),t=this.scroll().max.y,a=!1;if(y("message_id").length>0){var i=y("message_id"),r=e(s.content).find(".messages-list li[data-id='"+i+"']");r.length>0&&(a=r)}!1!==a?(BPBMJQ(this.getElements().host).addClass("user-scrolled"),this.scroll({el:a,scroll:"ifneeded",margin:20})):BPBMJQ(s.host).is(":visible")&&0===t?g(this,!0):(this.scrollStop(),this.scroll({y:"100%"}))},onScroll:function(e){var s=this,t=this.scroll(),a=t.position.y,i=t.max.y;0===i?(g(this,!0),BPBMJQ(s.getElements().host).addClass("user-scrolled")):0===a?(g(this),BPBMJQ(s.getElements().host).addClass("user-scrolled")):a>=i&&setTimeout(function(){a=t.position.y,i=t.max.y,a>=i&&BPBMJQ(s.getElements().host).removeClass("user-scrolled")},300)},onContentSizeChanged:function(e){var t=this.getElements(),a=this.scroll(),i=a.max.y,r=a.position.y,n=BPBMJQ(t.host),o=BPBMJQ(t.content).find(".list .messages-stack:last .content .messages-list li:last").outerHeight();o<100&&(o=100);var l=this;(!n.hasClass("user-scrolled")||i-r<o+50)&&(ee||(s=!0,l.scrollStop(),l.scroll({y:"100%"},100,void 0,function(){s=!1}))),setTimeout(function(){n.hasClass("user-scrolled")||ee||(s=!0,l.scrollStop(),l.scroll({y:"100%"},100,void 0,function(){s=!1}))},100)},onHostSizeChanged:function(){var s=this,t=this.scroll(),a=t.position.y,i=t.max.y;BPBMJQ(s.getElements().host).hasClass("user-scrolled")||e("body").hasClass("bpbm-os-dragging")?a>=i&&setTimeout(function(){a=t.position.y,i=t.max.y,a>=i&&BPBMJQ(s.getElements().host).removeClass("user-scrolled")},300):(this.scrollStop(),this.scroll({y:"100%"},0))}}}),BPBMJQ(".scroller.threads-list-wrapper").BPBMoverlayScrollbars({sizeAutoCapable:!1,overflowBehavior:{x:"hidden"},callbacks:{onInitialized:function(){},onScroll:function(e){var s=this.getElements(),t=this.scroll(),a=t.position.y,r=t.max.y,n=BPBMJQ(s.host);r-a<=100&&i(n)},onContentSizeChanged:function(e){}}})}),e(document).trigger("bp-better-messages-init-scrollers")),BPBMJQ(".scrollbar-inner").on("touchstart click mousewheel DOMMouseScroll",function(e){0===BPBMJQ(e.target).closest(".bpbm-reply").length&&BPBMJQ(this).addClass("user-scrolled")}),a(),"1"==BP_Messages.realtime){var h=[],v=[];e(".bp-messages-wrap:not(.bp-better-messages-mini,.bp-better-messages-list) .list .messages-stack .content .messages-list li:not(.seen), .bp-messages-wrap.bp-better-messages-mini .chat.open .list .messages-stack .content .messages-list li:not(.seen)").each(function(){var s=e(this).data("id"),t=e(this).data("thread");h.push(s),v.push(t)}),T&&(U.emit("threadOpen",T),updateGroupCallStatus(T)),"1"===BP_Messages.messagesStatus&&h.length>0&&U.emit("getStatuses",h,function(s){var t={};e.each(h,function(){t[this]=!0}),e.each(s,function(s){delete t[s];var a=e('.bp-messages-wrap .list .messages-stack .content .messages-list li[data-id="'+s+'"]');if(a.removeClass("sent delivered seen"),a.hasClass("my")||a.hasClass("fast")){var i="sent";e.each(this,function(){if("seen"==i)return!1;"delivered"==this&&"seen"!=i&&(i="delivered"),"seen"==this&&(i="seen")}),a.addClass(i);var r="";switch(i){case"sent":r=BP_Messages.strings.sent;break;case"delivered":r=BP_Messages.strings.delivered;break;case"seen":r=BP_Messages.strings.seen}a.find(".status").attr("title",r),o()}else"seen"!==this.toString()&&U.emit("seen",[s])}),e.each(t,function(s){var t=e('.bp-messages-wrap .list .messages-stack .content .messages-list li[data-id="'+s+'"]');t.removeClass("sent delivered seen"),t.addClass("seen"),t.find(".status").attr("title",BP_Messages.strings.seen),o()})}),v=function(s){var t=[];return e.each(s,function(s,a){-1===e.inArray(a,t)&&t.push(a)}),t}(v),e.each(v,function(e,s){void 0!==s&&U.emit("threadOpen",s)}),U.emit("requestUnread")}if(n(),e(window).on("resize",function(){n()}),e(".bp-messages-wrap #send-to:not(.ready)").length>0){var B=[],w=new Taggle("send-to",{placeholder:"",tabIndex:2,hiddenInputName:"recipients[]"}),P=w.getContainer(),C=w.getInput(),k=e('input[name="to"]');k.length>0&&(e(k).each(function(){var s=e(this).data("img"),t=e(this).data("label");w.add(e(this).val()),e(P).find(".taggle_sizer").text(""),e("#send-to li.taggle:last .taggle_text").html('<span class="bpbm-avatar"><img src="'+s+'" class="avatar photo" width="50" height="50"></span><span class="bpbm-name">'+t+"</span>"),e(this).remove()}),e("#send-to").removeClass("active"),e("#send-to input").css("width","10px")),e(C).on("blur",function(s){var t=e(P).find(".taggle_sizer").text();w.add(t)}),"0"===BP_Messages.disableUsersSearch&&(e(".bpbm-users-avatars-list .bpbm-users-avatars-list-item").click(function(s){s.preventDefault();var t=e(this),a=t.find(".bpbm-users-avatars-list-item-name").text(),i=t.find(".bpbm-users-avatars-list-item-avatar img").parent().html(),r=t.attr("data-nicename");w.add(r),e(P).find(".taggle_sizer").text(""),e("#send-to li.taggle:last .taggle_text").html('<span class="bpbm-avatar">'+i+'</span><span class="bpbm-name">'+a+"</span>")}),e(C).autocomplete({source:function(s,t){var a=s.term;a in B?t(B[a]):e.getJSON(BP_Messages.ajaxUrl+"?q="+a+"&limit=10&action=bp_messages_autocomplete&cookie="+function(){var e,s,t,a,i,r=document.cookie.split(";"),n={};for(e=0;e<r.length;e++)s=r[e],t=s.indexOf("="),a=BPBMJQ.trim(unescape(s.slice(0,t))),i=unescape(s.slice(t+1)),0===a.indexOf("bp-")&&(n[a]=i);return encodeURIComponent(BPBMJQ.param(n))}(),s,function(e,s,i){B[a]=e,t(e)})},minLength:2,appendTo:P,position:{at:"left bottom",of:P},open:function(s,t){var a=e(".bp-messages-wrap #send-to .ui-autocomplete"),i=parseInt(a.css("top"))-3;a.css("top",i)},select:function(s,t){if(s.preventDefault(),1===s.which){w.add(t.item.value),e(P).find(".taggle_sizer").text("");var a="";void 0!==t.item.img&&(a+='<span class="bpbm-avatar">'+t.item.img+"</span>"),a+='<span class="bpbm-name">'+t.item.label+"</span>",e("#send-to li.taggle:last .taggle_text").html(a)}},response:function(s,t){e(".ui-helper-hidden-accessible").hide()}}).autocomplete("instance")._renderItem=function(s,t){var a="";return void 0!==t.img&&(a+='<span class="bpbm-avatar">'+t.img+"</span>"),a+='<span class="bpbm-name">'+t.label+"</span>",e("<li>").attr("data-value",t.value).attr("data-label",t.label).append(a).appendTo(s)}),e("#send-to").addClass("ready")}void 0!==L&&L.find(".bp-messages-mobile-tap").css("line-height",L.height()+"px"),e(".bp-messages-side-threads .threads-list .thread.bp-messages-active-thread").removeClass("bp-messages-active-thread"),T&&e('.bp-messages-side-threads .threads-list .thread[data-id="'+T+'"]').addClass("bp-messages-active-thread");var j={},Q={},J={show:function(e){e.$trigger.closest("li").addClass("selected")},hide:function(e){e.$trigger.closest("li").removeClass("selected")}};j.copy={name:BP_Messages.strings.copy_text,icon:"fas fa-copy",callback:function(e,s){var t=s.$trigger,a=t.find(".bpbm-replied-message-reply");m(a.length>0?a.text():t.text())}},Q.copy={name:BP_Messages.strings.copy_text,icon:"fas fa-copy",callback:function(e,s){var t=s.$trigger,a=t.find(".bpbm-replied-message-reply");m(a.length>0?a.text():t.text())}},"1"===BP_Messages.allowEditMessages&&(j.edit={name:BP_Messages.strings.edit,icon:"fas fa-pen",callback:function(s,t){var a=t.$trigger,i=BP_Messages.userNonce,r=a.closest("li"),n=r.closest(".messages-stack").closest(".bp-messages-threads-wrapper"),o=r.attr("data-id"),l="",d="",c=r.find(".bpbm-replied-message-reply");c.length>0?l+=c.text():l+=r.find(".message-content").text();var p=r.find(".message-content > [data-desc]");p.length>0&&p.each(function(){var s=e(this).attr("data-desc");void 0!==s&&(d+='<span class="bpbm-preview-desc">'+atob(s)+"</span>")});var m='<div class="bpbm-preview-message bpbm-edit-message" style="display:none" data-message-id="'+o+'"><div class="bpbm-preview-message-cancel"><i class="far fa-times-circle"></i></div><div class="bpbm-preview-message-content"><span class="bpbm-preview-message-name">'+BP_Messages.strings.edit_message+'</span><div class="bpbm-preview-message-text"></div></div></div>',g=n.find(".bpbm-preview-message");g.length>0?(g=g.replaceWith(m),(g=n.find(".bpbm-preview-message")).show(),M()):(g=e(m).insertBefore(n.find(".reply"))).slideDown(100,function(){M()}),g.find(".bpbm-preview-message-text").text(l),g.find(".bpbm-preview-message-text").append(d),g.find(".bpbm-gifs-icon").html(X.gif),e.post(BP_Messages.ajaxUrl,{action:"bp_messages_get_edit_message",message_id:o,_wpnonce:i},function(e){if(void 0!==e.errors)BBPMShowError(e.errors[0]),g.find(".bpbm-preview-message-cancel").click();else{var s=n.find(".bp-emojionearea-editor");s.length>0?s.html(emojione.toImage(e)):n.find(".reply .message textarea").val(e)}})},visible:function(e,s){return s.$trigger.closest(".bp-messages-threads-wrapper").find(".reply").length>0}});var E={name:BP_Messages.strings.delete,icon:"fas fa-trash",callback:function(s,t){var a=t.$trigger,i=BP_Messages.userNonce,r=BP_Messages.strings.confirm_delete,n=a.closest("li");if(confirm(r)){var o=[n.attr("data-id")],l=n.attr("data-thread");e.post(BP_Messages.ajaxUrl,{action:"bp_messages_delete_message",thread_id:l,messages_ids:o,_wpnonce:i},function(s){s.result?(BBPMNotice(s.message),function(s){e.each(s,function(){var s=e('.bp-messages-wrap .list .messages-stack .content .messages-list li[data-id="'+this+'"]'),t=s.closest(".messages-stack");s.remove(),0===t.find(".messages-list > li").length&&t.remove(),e(G+'[data-message="'+this+'"] .info p').text("...")})}(o)):BBPMShowError(s.errors[0])})}},visible:function(e,s){return s.$trigger.closest(".bp-messages-threads-wrapper").find(".reply").length>0&&(!("1"!==BP_Messages.allowDeleteMessages||!s.$trigger.closest(".messages-stack").hasClass("outgoing"))||!!s.$trigger.closest(".list").hasClass("can-moderate"))}};if("1"===BP_Messages.enableReplies&&(Q.reply={name:BP_Messages.strings.reply,icon:"fas fa-reply",callback:function(e,s){s.$trigger.closest("li").find(".bpbm-reply").click()},visible:function(e,s){return s.$trigger.closest(".bp-messages-threads-wrapper").find(".reply").length>0}}),j.delete=E,Q.delete=E,"0"!==BP_Messages.user_id){e.BPBMcontextMenu({selector:Y,events:J,items:j,autoHide:!1,zIndex:10,position:function(e,s,t){var a=window.innerWidth-e.$menu.width()-100;s>a&&(s=a),e.$menu.css({left:s,top:t})}}),e.BPBMcontextMenu({selector:q,events:J,items:Q,autoHide:!1,zIndex:10,position:function(e,s,t){var a=window.innerWidth-e.$menu.width()-100;s>a&&(s=a),e.$menu.css({left:s,top:t})}});var z={};z.open={name:BP_Messages.strings.open,icon:"fas fa-external-link-square-alt",callback:function(e,s){s.$trigger.closest(".thread").click()}},z.delete={name:BP_Messages.strings.delete,icon:"fas fa-trash",callback:function(e,s){s.$trigger.closest(".thread").find("span.delete").click()},visible:function(e,s){return s.$trigger.closest(".thread").find("span.delete").length>0}},e.BPBMcontextMenu({selector:G,events:J,items:z,autoHide:!1,zIndex:10,position:function(e,s,t){var a=window.innerWidth-e.$menu.width()-100;s>a&&(s=a),e.$menu.css({left:s,top:t})}}),p()}x(L),e(".bpbm-gifs-icon").html(X.gif),c(),d(),V&&void 0!==L&&L.find(".bpbm-chat-content").css("max-height","calc( 100% - "+L.find(".chat-header").outerHeight()+"px )"),document.dispatchEvent(new BPBMEvent("bp-better-messages-reinit-end")),H=!1}function d(e){void 0===e&&(e=BPBMJQ(".bp-messages-wrap")),V||e.find(".bpbm-users-avatars-list-item[title], .status[title], .bpbm-reply[title], .chat-header [title], .chat-footer [title], .threads-list [title], .chats .chat .head .controls [title]").each(function(){var e=BPBMJQ(this);e.is("strong")||e.is("input")||(void 0!==e[0]._tippy&&e[0]._tippy.destroy(),bpbmtippy(e[0],{placement:"top",content:e.attr("title"),allowHTML:!0,arrow:!1,offset:[0,5],onShow:function(e){var s=BPBMJQ(e.reference);if(s.is(".expandingButtons")&&s.hasClass("expandingButtonsOpen"))return!1}}),e[0].removeAttribute("title"))})}function c(){e(".bp-messages-iframe-container").each(function(){e(this).closest(".message-content").addClass("has-iframe")})}function p(){V&&(e(q).BPBMswipe("destroy"),e(q).BPBMswipe({longTap:function(s,t){e(this).contextMenu({x:s.changedTouches[0].screenX,y:s.changedTouches[0].screenY})}}),e(Y).BPBMswipe("destroy"),e(Y).BPBMswipe({longTap:function(s,t){e(this).contextMenu({x:s.changedTouches[0].screenX,y:s.changedTouches[0].screenY})}}),e(G).BPBMswipe("destroy"),e(G).BPBMswipe({longTap:function(s,t){e(this).contextMenu({x:s.changedTouches[0].screenX,y:s.changedTouches[0].screenY})}}))}function m(s){var t=e("<input>");e("body").append(t),t.val(s).select(),document.execCommand("copy"),t.remove()}function g(s,t){void 0===t&&(t=!1);var a=s.getElements(),i=BPBMJQ(a.host);if(i.hasClass("loadingAtTheMoment")||i.hasClass("allMessagesWasLoaded"))return!1;var r=i.data("id");i.find(".loading-messages").show(),i.addClass("loadingAtTheMoment");var n=i.find(".messages-stack:first-child .messages-list li:first-child"),o=n.attr("data-id");e.post(BP_Messages.ajaxUrl,{action:"bp_messages_thread_load_messages",thread_id:r,message_id:o},function(a){i.find(".loading-messages").hide(),""===a.trim()&&i.addClass("allMessagesWasLoaded"),e(a).prependTo(i.find(".list")),i.addClass("hasLoadedMessages"),s.scroll({el:n.closest(".messages-stack"),margin:15}),l(),i.removeClass("loadingAtTheMoment"),t&&0===s.scroll().max.y&&g(s,!0)})}function h(s){if(void 0===s&&(s=".bp-messages-wrap:not(.bp-better-messages-mini,.bp-better-messages-list)"),0!=e(s+" .list").length){var t=e(s+" .scroller[data-id]"),a=t.data("id");if(void 0!==z[a])return!1;var i=e(s+" .list"),r=i[0].offsetHeight;if(y("message_id").length>0){var n=y("message_id"),o=e(s+" .messages-list li[data-id='"+n+"']");o.length>0&&(r=o[0].offsetTop-o[0].offsetHeight-100)}var l=i.closest(".scroller"),d=l.hasClass("user-scrolled"),c=l[0].scrollHeight-l.scrollTop()-l.height();if(!(r<l.outerHeight())&&(!d||100>=c)){var p=t.BPBMoverlayScrollbars();void 0!==p&&(p.update(),p.scroll({y:"100%"}))}}}function b(){if(clearInterval(D),D=setTimeout(b,BP_Messages.siteRefresh),"1"!=BP_Messages.realtime&&!te){var t=k("bp-messages-last-check");te=!0,e.post(BP_Messages.ajaxUrl,{action:"bp_messages_check_new",last_check:t},function(t){t.threads.length>0&&e.each(t.threads,function(){void 0!==this.avatar&&(this.avatar=this.avatar.replace("loading='lazy'","").replace('loading="lazy"',"")),function(s){if(void 0===s.html)return!1;if(s.fast||"1"==s.edit)return!1;e(".bp-messages-wrap .threads-list .empty").remove(),e(".bp-messages-wrap .bp-messages-threads-wrapper.no-threads").removeClass("no-threads");var t=s.thread_id,a=s.html;a=a.replace('loading="lazy"',"");var i=e(G+"[data-id='"+t+"']");if(i.length>0){var r=s.content_site;i.each(function(){var t=e(this),a=t.find(".info p"),i=t.closest(".threads-list");if(i.removeClass("empty"),a.html(r),void 0!==a.attr("writing-reserved")&&a.attr("writing-reserved",r),t.attr("data-message",s.id),t.prependTo(i),"1"===BP_Messages.realtime){var n=t.find(".time-wrapper"),o=parseInt(s.timestamp);n.livestamp(new Date(1e3*o))}else"1"!==BP_Messages.realtime&&void 0!==s.html&&t.replaceWith(s.html)})}else e(".bp-messages-wrap .threads-list").each(function(){0===e(this).closest(".bpbm-search-results-section").length&&(e(this).removeClass("empty"),e(a).prependTo(e(this)))});void 0===BP_Messages.mutedThreads[t]&&BP_Messages.user_id!=s.user_id&&(void 0!==s.count_unread?"0"!==s.count_unread&&C(s.id):C(s.id));_()}(this),S||w(this.thread_id,this.message,this.name,this.avatar)}),s(t.total_unread),te=!1})}}function u(){if("0"===BP_Messages.user_id)return!1;if(clearInterval(D),D=setTimeout(u,BP_Messages.threadRefresh),"1"!=BP_Messages.realtime&&!ae){var t=k("bp-messages-last-check"),i=e(".messages-stack:last-child .messages-list li:last-child").attr("data-time");ae=!0,e.post(BP_Messages.ajaxUrl,{action:"bp_messages_thread_check_new",last_check:t,thread_id:T,last_message:i},function(t){e.each(t.messages,function(){"string"==typeof this.avatar&&(this.avatar=this.avatar.replace("loading='lazy'","").replace('loading="lazy"',"")),function(s,t){if("string"==typeof BP_Messages.fast&&s.fast&&"1"!==BP_Messages.fast)return!1;var i=!1,r=!1;void 0===t&&(t=".bp-messages-wrap:not(.bp-better-messages-mini,.bp-better-messages-list)");if(""==s.message.trim())return!1;var n="1"==s.edit;if("1"==BP_Messages.realtime&&s.fast){if(e(t+' .messages-list li[data-temp-id="'+s.id+'"]').length>0)return!1}var l;l="string"!=typeof s.avatar||"1"!==BP_Messages.showAvatars?"":'<div class="pic">'+s.avatar.replace("loading='lazy'","").replace('loading="lazy"',"")+"</div>";"1"!=BP_Messages.realtime||s.fast||(n?(i=!0,s.temp_id=s.id):s.temp_id&&(i=!0));var m=moment(D).format("YYYY-MM-DD HH:mm:ss").toString(),g=e(t+" .messages-stack:last-child"),h="standard";g.closest(".bp-messages-wrap").hasClass("bpbm-template-modern")&&(h="modern");0===g.length&&e(t+" .empty-thread").length>0&&(r=!0);var b=e(t+' .messages-list li[data-id="'+s.id+'"]'),u="";e("body").hasClass("bp-messages-mobile")&&parseInt(s.thread_id)===parseInt(T)||ifvisible.now("active")||"1"!=BP_Messages.realtime||s.user_id===BP_Messages.user_id||(u+=" unread");s.user_id==BP_Messages.user_id&&(u+=" my");s.fast&&(u+=" fast");s.user_id==BP_Messages.user_id&&"1"==BP_Messages.realtime&&(u+=" sent");u=u.trim();var f=e(t+' .messages-list li[data-id="'+s.temp_id+'"]');n&&f.length>0&&(u=f.attr("class"));var v="";i&&(v=' data-temp-id="'+s.temp_id+'"');var B='<li class="'+u+'" data-thread="'+s.thread_id+'" title="'+m+'" data-time="'+s.timestamp+'" data-id="'+s.id+'" '+v+">",w="",P="",M="",k="message-content";"1"===BP_Messages.enableReplies&&(s.user_id!=BP_Messages.user_id&&(P='<span class="bpbm-reply" title="'+BP_Messages.strings.reply+'"><i class="fas fa-reply"></i></span>'),k+=" reply-enabled");"1"===BP_Messages.messagesStatus&&s.user_id==BP_Messages.user_id&&(w+='<span class="status" title="'+BP_Messages.strings.sent+'"></span>');"1"!==BP_Messages.disableFavoriteMessages&&(M+='<span class="favorite"><i class="fas" aria-hidden="true"></i></span>');"standard"===h&&(B+=w,B+=M,B+=P);B+='<span class="'+k+'">',"modern"===h&&(B+=P,B+=w,B+=M);if(B+=s.message,B+="</span></li>",i&&f.length>0)return s.message!==f.find(".message-content").html()?(f.replaceWith(B),e('.bp-messages-wrap .list .messages-stack .content .messages-list li[data-id="'+s.id+'"]').each(function(){o(),d(BPBMJQ(this))})):(f.attr("data-id",s.id),f.removeClass("fast"),o()),p(),c(),!0;if(0===b.length&&(g.length>0||r)){1==r&&e(t+" .empty-thread").remove();var y=!0,x=new Date(1e3*g.find(".messages-list > li:last-child").attr("data-time")),j=x.getFullYear()+"-"+x.getMonth()+"-"+x.getDate()+"-"+x.getHours()+"-"+x.getMinutes(),D=new Date(1e3*s.timestamp),U=D.getFullYear()+"-"+D.getMonth()+"-"+D.getDate()+"-"+D.getHours()+"-"+D.getMinutes();if(g.attr("data-user-id")===s.user_id&&(y=!1),j!==U&&(y=!0),!1===y)g.find(".messages-list").append(B);else{var S="messages-stack";s.user_id==BP_Messages.user_id?S+=" outgoing":S+=" incoming";var L='<a href="'+s.link+'">'+s.name+"</a>";!1===s.link&&(L="<span>"+s.name+"</span>");var Q='<div class="'+S+'" data-user-id="'+s.user_id+'">';Q+=l,Q+='<div class="content"><div class="info"><div class="name">'+L+'</div><div class="time" title="'+m+'" data-livestamp="'+s.timestamp+'"></div></div><ul class="messages-list"></ul></div></div>',e(t+" .list").append(Q),e(t+" .messages-stack:last-child .messages-list").append(B)}"function"==typeof e.fn.BPBMmagnificPopup&&e(".bp-messages-wrap .list .messages-stack .content .messages-list li .images").BPBMmagnificPopup({delegate:"a",type:"image"}),void 0===BP_Messages.mutedThreads[s.thread_id]&&BP_Messages.user_id!=s.user_id&&(void 0!==s.count_unread?"0"!==s.count_unread&&C(s.id):C(s.id))}var J=e('.bp-messages-wrap .list .messages-stack .content .messages-list li[data-id="'+s.id+'"]');V||J.find(".bpbm-gif").each(function(){var s=e(this);s.find(".bpbm-gif-play").remove();s.find("video")[0].play()});e(".bpbm-gifs-icon").html(X.gif),o(),a(),_(),p(),c(),d(J),document.dispatchEvent(new BPBMEvent("bp-better-messages-message-render-end"))}(this)}),e.each(t.threads,function(){"string"==typeof this.avatar&&(this.avatar=this.avatar.replace("loading='lazy'","").replace('loading="lazy"',"")),w(this.thread_id,this.message,this.name,this.avatar)}),s(t.total_unread),ae=!1})}}function f(){if(!store.enabled)return!1;Q=store.get("bp-better-messages-open-threads")||{},!1!==T&&(Q[T]=Date.now()),e.each(Q,function(e){this+2e3<Date.now()&&delete Q[e]}),store.set("bp-better-messages-open-threads",Q)}function v(t,a){if(void 0===a){var i=BPBMJQ(event.target);a=i.hasClass("bp-messages-wrap")?i:i.closest(".bp-messages-wrap")}if(N){if(!1===confirm(BP_Messages.strings.you_are_in_call))return!1;BPBMJQ(document).trigger("bpbm-end-call"),BPBMJQ(document).trigger("bpbm-end-group-call")}if(void 0===window.BMAppDeviceId&&a.hasClass("bp-messages-wrap-main")&&!a.hasClass("bp-messages-group-thread"))try{window.history.pushState("","",t)}catch(e){}j(a);var r=a.height();a.css("min-height",r),e(window).off(".bp-messages");var n="",o=!1;void 0!==BP_Messages.ajaxUrl.split("?")[1]&&(o=!0),o?n+="&":(o=!0,n+="?"),void 0!==t.split("?")[1]?n+=t.split("?")[1]+"&action=bp_messages_load_via_ajax":n+="action=bp_messages_load_via_ajax";var d=a.find(".bp-messages-side-threads"),c=BP_Messages.ajaxUrl+n;d.length>0&&(c+="&ignore_threads"),e(".bpbm-notice").remove(),e(document).trigger("bp-better-messages-ajax-refresh-start"),e.ajax({method:"GET",url:c,dataType:"json",cache:!1,success:function(t){void 0!==t.total_unread&&s(t.total_unread),void 0!==t.errors&&e.each(t.errors,function(){BBPMShowError(this)});var i=t.html,r=e(i),n=r.find(".bp-messages-side-threads");if(d.length>0&&n.length>0?(a.find(".bp-messages-threads-wrapper .bp-messages-column").html(r.find(".bp-messages-threads-wrapper .bp-messages-column").html()),a.find(".bp-messages-threads-wrapper").closest(".bp-messages-wrap").find(".chat-header:not(.side-header)").html(r.find(".bp-messages-threads-wrapper").closest(".bp-messages-wrap").find(".chat-header:not(.side-header)").html())):a.html(e(r).html()),a.hasClass("bp-messages-wrap-main")){r.attr("data-thread-id")?a.attr("data-thread-id",r.attr("data-thread-id")):a.removeAttr("data-thread-id"),void 0!==t.errors&&e(t.errors.join("")).insertBefore(a)}a.is("#bp-better-messages-mini-mobile-container")&&a.attr("data-thread",r.attr("data-thread-id")),a.hasClass("bp-messages-wrap-chat")&&a.find(".chat-header .back").remove(),l(),a.removeClass("bpbm-call-view"),a.css("min-height",""),e(document).trigger("bp-better-messages-ajax-refresh-end")}})}function _(){e(".bp-messages-wrap img.avatar[data-user-id]").each(function(){var s=e(this),t=s.attr("data-user-id"),a=s.attr("data-bpbm-status-color"),i=!1;if(s.parent().hasClass("bbpm-avatar")&&(i=s.parent()),!i){var r=s.data("size"),n=s.data("size"),o=s.height(),l=s.height();r<o&&(o=r),n<l&&(l=n);var d=s.css("marginTop"),c=s.css("marginLeft"),p=s.css("marginBottom"),m=s.css("marginRight");e(this).css({marginTop:0,marginLeft:0,marginRight:0,marginBottom:0});var g='<span class="avatar bbpm-avatar" data-user-id="'+t+'"';"0"!==BP_Messages.userStatus&&void 0!==a&&(g+='style="color:'+a+'"'),g+="></span>",s.wrap(g),(i=s.parent()).css({marginTop:d,marginLeft:c,marginRight:m,marginBottom:p,minWidth:o,minHeight:l})}E.indexOf(t)>-1?e(i).addClass("online"):e(i).removeClass("online")}),B()}function B(){var s=e(".bp-better-messages-list .tabs-content .friends, .bpbm-friends-list");s.length>0&&s.each(function(){var s=e(this).find(".bp-messages-user-list");if(s.length>0){var t=[];s.find(" > .user").each(function(){var a=e(this),i=a.attr("data-id"),r=a.prev().hasClass("online");E.indexOf(i)>-1?(a.addClass("online"),r||a.prependTo(s)):(t.push(a),a.removeClass("online"))}),t.length>0&&e.each(t,function(){var t=e(this);t.next().hasClass("online")&&t.insertAfter(s.find(" > .user.online:last"))})}})}function w(s,t,a,i){if("1"!==BP_Messages.disableOnSiteNotification&&void 0===Q[s]&&void 0===BP_Messages.mutedThreads[s]&&!e("body").hasClass("bp-messages-mobile")){if(e(G+'[data-id="'+s+'"]:visible').length>0)return!1;var r=i.match(/src\="([^\s]*)"\s/),n=i.match(/src\='([^\s]*)'\s/);null!=r&&(i=r[1]),null!=n&&(i=n[1]);var o=e(".amaran.thread_"+s);if(o.length>0){o.find(".icon > img").attr("src",i);var l="<b>"+a+"</b>";return l+=t,o.find(".info").html(l),!0}"1"==BP_Messages.miniMessages&&"messages"===J||(e.amaran({theme:"user message thread_"+s,content:{img:i,user:a,message:t},sticky:!0,closeOnClick:!1,closeButton:!0,delay:1e4,thread_id:s,position:"bottom right",onClick:function(){if(V){var t=e("#bp-better-messages-mini-mobile-open");if(t.length>0){var a=BP_Messages.baseUrl;BP_Messages.baseUrl=BP_Messages.threadUrl+this.thread_id,t.click(),BP_Messages.baseUrl=a,e(".amaran.user.message.thread_"+s).remove()}else location.href=BP_Messages.threadUrl+this.thread_id}else{var i=location.href=BP_Messages.threadUrl+this.thread_id+"&acceptCall",r=e(".bp-messages-wrap.bp-messages-wrap-main");r.length>0?v(i,r):location.href=i}}}),e(".bpbm-gifs-icon").html(X.gif)),void 0!==t.count_unread?"0"!==t.count_unread&&C(t.id):C(t.id)}}function P(){if("1"!==BP_Messages.hPBE)return!1;e("*:not(.bp-messages-hide-on-full-screen)").filter(function(){return("fixed"===e(this).css("position")||"absolute"===e(this).css("position"))&&!e(this).hasClass("bp-messages-wrap")&&0===e(this).closest(".uppy").length&&0===e(this).closest(".bp-messages-wrap").length}).addClass("bp-messages-hide-on-full-screen")}function M(){e("span.writing").each(function(){var s=e(this),t=s.closest(".bp-messages-threads-wrapper"),a=t.find(".reply").outerHeight(),i=t.find(".bpbm-preview-message").outerHeight();void 0!==i&&(a+=i),s.css("bottom",a)})}function C(e){if("1"!==BP_Messages.enableSound||"dnd"===BP_Messages.userStatus)return!1;"string"==typeof e&&"tmp_"!==e.substr(0,4)&&void 0!==K.notification&&K.notification.play()}function k(e){for(var s=e+"=",t=document.cookie.split(";"),a=0;a<t.length;a++){for(var i=t[a];" "==i.charAt(0);)i=i.substring(1,i.length);if(0==i.indexOf(s))return i.substring(s.length,i.length)}return null}function y(e){var s="[\\?&]"+(e=e.replace(/[\[]/,"\\[").replace(/[\]]/,"\\]"))+"=([^&#]*)",t=new RegExp(s).exec(window.location.search);return null==t?"":decodeURIComponent(t[1].replace(/\+/g," "))}function x(s){if(void 0===s)return!1;s.each(function(){var s=BPBMJQ(this);if(s.is(":visible")){var t=s.find(".chat-header:not(.side-header)"),a=t.find("> strong"),i=t.find("> .user"),r=0;t.find("> a:visible:not(.user),> div:visible").each(function(){r+=e(this).width()});var n=r+10;a.length>0&&a.css("width","calc(100% - "+n+"px)"),i.length>0&&i.css("max-width","calc(100% - "+n+"px)"),s.find(".chats .chat").each(function(){var s=BPBMJQ(this).find("> .head"),t=s.find("> .title"),a=0;s.find("> div.controls").each(function(){a+=e(this).width()});var i=a+40;t.length>0&&t.css("max-width","calc(100% - "+i+"px)")})}else setTimeout(function(){x(s)},100)})}function j(e){var s=e.find(".chat-header").height(),t=e.find(".preloader");t.show(),t.parent().hasClass("bp-messages-column")||(t.css("top",s),t.css("height","calc(100% - "+s+"px)"))}var D,T,U,S,L,Q={},J=!1,E=[],z={},I={},H=!1,A=!1,O=0!==e('html[dir="rtl"]').length,N=(window.RTCPeerConnection||window.webkitRTCPeerConnection,window.mozRTCSessionDescription||window.RTCSessionDescription,!1),$=!1,R=document.title,W='<div class="loading-messages"><div class="bounce1"></div><div class="bounce2"></div><div class="bounce3"></div></div>',F=!1;if(void 0!==BP_Messages.badWordList)try{F=JSON.parse(atob(BP_Messages.badWordList))}catch(e){}var q=".bp-messages-wrap .list .messages-stack.incoming .content .messages-list li .message-content",Y=".bp-messages-wrap .list .messages-stack.outgoing .content .messages-list li .message-content",G=".bp-messages-wrap .threads-list .thread";if(store.enabled&&"1"==BP_Messages.realtime){var Z=store.get("bp-better-messages-last-unread");void 0!==Z&&parseInt(BP_Messages.total_unread)!==parseInt(Z)&&s(Z)}ifvisible.setIdleDuration(3);var X={gif:'<svg xmlns="http://www.w3.org/2000/svg" viewBox="5.002 9.969 23.017 13.042">\n<g stroke="none" stroke-width="1" fill="none" fill-rule="evenodd">\n<g fill="currentColor">\n<path d="M8.00684834,10 C6.34621185,10 5,11.3422643 5,12.9987856 L5,20.0012144 C5,21.6573979 6.33599155,23 8.00684834,23 L24.9931517,23 C26.6537881,23 28,21.6577357 28,20.0012144 L28,12.9987856 C28,11.3426021 26.6640085,10 24.9931517,10 L8.00684834,10 L8.00684834,10 Z M7.99456145,11 C6.89299558,11 6,11.9001762 6,12.992017 L6,20.007983 C6,21.1081436 6.90234375,22 7.99456145,22 L25.0054385,22 C26.1070044,22 27,21.0998238 27,20.007983 L27,12.992017 C27,11.8918564 26.0976562,11 25.0054385,11 L7.99456145,11 L7.99456145,11 Z M13,17 L13,19 L10.9998075,19 C10.4437166,19 10,18.5523709 10,18.0001925 L10,14.9998075 C10,14.4437166 10.4476291,14 10.9998075,14 L14,14 L14,13 L11.0048815,13 C9.89761602,13 9,13.8865548 9,15.0059191 L9,17.9940809 C9,19.1019194 9.8938998,20 11.0048815,20 L14,20 L14,19.25 L14,19.25 L14,17 L14,16 L11,16 L11,17 L13,17 L13,17 Z M16,14 L16,19 L15,19 L15,20 L18,20 L18,19 L17,19 L17,14 L18,14 L18,13 L15,13 L15,14 L16,14 L16,14 Z M20,16 L20,14 L24,14 L24,13 L19,13 L19,20 L20,20 L20,17 L23,17 L23,16 L20,16 L20,16 Z"/>\n</g>\n</g>\n</svg>'},K={};BP_Messages.soundLevels.notification>0&&(K.notification=new Howl({src:[BP_Messages.assets+"notification.mp3",BP_Messages.assets+"notification.ogg"],loop:!1,volume:BP_Messages.soundLevels.notification})),BP_Messages.soundLevels.sent>0&&(K.sent=new Howl({src:[BP_Messages.assets+"sent.mp3",BP_Messages.assets+"sent.ogg"],loop:!1,volume:BP_Messages.soundLevels.sent})),e.fn.BPBMremoveAttributes=function(){return this.each(function(){var s=e.map(this.attributes,function(e){return e.name}),t=e(this);e.each(s,function(e,s){t.removeAttr(s)})})},e(window).on("focus",function(){ifvisible.focus()}),e(window).on("blur",function(){ifvisible.blur()}),e(window).on("click",function(){e(".bp-messages-wrap .expandingButtons.expandingButtonsOpen").removeClass("expandingButtonsOpen")});var V=!1;(/iPad|iPhone|iPod/.test(navigator.userAgent)||/(android|bb\d+|meego).+mobile|avantgo|bada\/|blackberry|blazer|compal|elaine|fennec|hiptop|iemobile|ip(hone|od)|iris|kindle|Android|Silk|lge |maemo|midp|mmp|netfront|opera m(ob|in)i|palm( os)?|phone|p(ixi|re)\/|plucker|pocket|psp|series(4|6)0|symbian|treo|up\.(browser|link)|vodafone|wap|windows (ce|phone)|xda|xiino/i.test(navigator.userAgent)||/1207|6310|6590|3gso|4thp|50[1-6]i|770s|802s|a wa|abac|ac(er|oo|s\-)|ai(ko|rn)|al(av|ca|co)|amoi|an(ex|ny|yw)|aptu|ar(ch|go)|as(te|us)|attw|au(di|\-m|r |s )|avan|be(ck|ll|nq)|bi(lb|rd)|bl(ac|az)|br(e|v)w|bumb|bw\-(n|u)|c55\/|capi|ccwa|cdm\-|cell|chtm|cldc|cmd\-|co(mp|nd)|craw|da(it|ll|ng)|dbte|dc\-s|devi|dica|dmob|do(c|p)o|ds(12|\-d)|el(49|ai)|em(l2|ul)|er(ic|k0)|esl8|ez([4-7]0|os|wa|ze)|fetc|fly(\-|_)|g1 u|g560|gene|gf\-5|g\-mo|go(\.w|od)|gr(ad|un)|haie|hcit|hd\-(m|p|t)|hei\-|hi(pt|ta)|hp( i|ip)|hs\-c|ht(c(\-| |_|a|g|p|s|t)|tp)|hu(aw|tc)|i\-(20|go|ma)|i230|iac( |\-|\/)|ibro|idea|ig01|ikom|im1k|inno|ipaq|iris|ja(t|v)a|jbro|jemu|jigs|kddi|keji|kgt( |\/)|klon|kpt |kwc\-|kyo(c|k)|le(no|xi)|lg( g|\/(k|l|u)|50|54|\-[a-w])|libw|lynx|m1\-w|m3ga|m50\/|ma(te|ui|xo)|mc(01|21|ca)|m\-cr|me(rc|ri)|mi(o8|oa|ts)|mmef|mo(01|02|bi|de|do|t(\-| |o|v)|zz)|mt(50|p1|v )|mwbp|mywa|n10[0-2]|n20[2-3]|n30(0|2)|n50(0|2|5)|n7(0(0|1)|10)|ne((c|m)\-|on|tf|wf|wg|wt)|nok(6|i)|nzph|o2im|op(ti|wv)|oran|owg1|p800|pan(a|d|t)|pdxg|pg(13|\-([1-8]|c))|phil|pire|pl(ay|uc)|pn\-2|po(ck|rt|se)|prox|psio|pt\-g|qa\-a|qc(07|12|21|32|60|\-[2-7]|i\-)|qtek|r380|r600|raks|rim9|ro(ve|zo)|s55\/|sa(ge|ma|mm|ms|ny|va)|sc(01|h\-|oo|p\-)|sdk\/|se(c(\-|0|1)|47|mc|nd|ri)|sgh\-|shar|sie(\-|m)|sk\-0|sl(45|id)|sm(al|ar|b3|it|t5)|so(ft|ny)|sp(01|h\-|v\-|v )|sy(01|mb)|t2(18|50)|t6(00|10|18)|ta(gt|lk)|tcl\-|tdg\-|tel(i|m)|tim\-|t\-mo|to(pl|sh)|ts(70|m\-|m3|m5)|tx\-9|up(\.b|g1|si)|utst|v400|v750|veri|vi(rg|te)|vk(40|5[0-3]|\-v)|vm40|voda|vulc|vx(52|53|60|61|70|80|81|83|85|98)|w3c(\-| )|webc|whit|wi(g |nc|nw)|wmlb|wonu|x700|yas\-|your|zeto|zte\-/i.test(navigator.userAgent.substr(0,4)))&&(V=!0),"1"===BP_Messages.forceMobile&&(V=!0);var ee=!1;V&&(e(window).on("touchstart",function(){ee=!0}),e(window).on("touchend",function(){ee=!1}),BP_Messages.miniChats="0");var se="bp-better-messages-mobile-holder";store.enabled&&(Q=store.get("bp-better-messages-open-threads")||{},store.get("bp-better-messages-mini-chats")||{},J=store.get("bp-better-messages-mini-messages")||!1,setInterval(f,1e3)),e(document).ready(function(){r()}),BPBMJQ(document).on("click",".bp-messages-wrap .chat-header .bpbm-maximize",function(s){s.preventDefault();var t=BPBMJQ(this).closest(".bp-messages-wrap");0===e(".bp-better-messages-mobile-holder").length&&e('<div class="bp-better-messages-mobile-holder"></div>').insertBefore(t);var a=t;a.addClass("bp-messages-full-screen");var i=window.innerHeight;e("html").addClass("bp-messages-full-screen").css("overflow","hidden"),e("body").addClass("bp-messages-full-screen").css("min-height",i),e(".bp-better-messages-mini .chats .chat.open").removeClass("open");var r=a.appendTo(e("body"));r.find(".user-scrolled").removeClass("user-scrolled"),r.show(),x(r),e(window).trigger("resize"),A=!0}),BPBMJQ(document).on("click",".bp-messages-wrap .chat-header .bpbm-minimize",function(s){s.preventDefault();var t=BPBMJQ(this).closest(".bp-messages-wrap");if(t.hasClass("bp-messages-full-screen")){s.preventDefault(),s.stopImmediatePropagation(),e("html").removeClass("bp-messages-full-screen").css("overflow","auto"),t.removeClass("bp-messages-full-screen").css("min-height",""),e("body").removeClass("bp-messages-full-screen").css("min-height",""),A=!1;var a=t;a.removeClass("bp-messages-full-screen"),a.removeAttr("id");var i=e(".bp-better-messages-mobile-holder");a.insertBefore(i),a.find(".user-scrolled").removeClass("user-scrolled"),i.remove(),e(window).trigger("resize"),x(a)}A=!1}),BPBMJQ(document).on("bp-better-messages-update-unread",function(e){var s=BPBMJQ(".bp-better-messages-unread");if(I=parseInt(e.originalEvent.detail.unread),(isNaN(I)||I<0)&&(I=0),store.set("bp-better-messages-last-unread",I),s.each(function(){var e=BPBMJQ(this),s=e.hasClass("bpbmuc");e.text(I),s?e.attr("data-count",I):0===I?e.addClass("no-count"):e.removeClass("no-count")}),BPBMJQ("body").hasClass("my-account")){var t=BPBMJQ("#user-bp_better_messages_tab");if(t.length>0){var a=t.find("span.count");I>0?a.length>0?a.text(I):BPBMJQ('<span class="count">'+I+"</span>").appendTo(t):a.remove()}}}),jQuery(document).on("bp-better-messages-reinit",function(e){l()});var te=!1,ae=!1;BPBMJQ(document).on("bp-better-messages-refresh-thread",function(e){u()}),jQuery(document).on("bp-better-messages-ajax-refresh",function(e){v(e.originalEvent.detail.url,e.originalEvent.detail.container)}),e(document).on("submit",".side-header > .bpbm-search form",function(e){e.preventDefault(),e.stopImmediatePropagation()});var ie=!1;e(document).on("change keyup",'.side-header > .bpbm-search input[name="search"]',function(s){var t=e(this),a=t.val().trim(),i=t.closest("form").find(".close"),r=t.closest(".bp-messages-side-threads"),n=r.find(".bpbm-search-results"),o=r.find(".threads-list");t.data("search-term")!==a&&(""===a?(o.show(),n.hide(),i.hide(),t.data("search-term",a)):(n.show(),i.show(),o.hide(),ie&&ie.abort(),0===n.find(".loading-messages").length&&n.html(W),t.data("search-term",a),ie=e.post(BP_Messages.ajaxUrl,{action:"bp_messages_thread_search",search:a},function(s){n.html(s),ie=!1,_(),e(".bpbm-gifs-icon").html(X.gif)})))}),e(document).on("change keyup",".bpbm-search-in-list > input",function(s){var t=e(this),a=t.val().trim().toLowerCase(),i=t.parent().next();i.hasClass("threads-list")||i.find("> div").each(function(){var s=e(this);-1===s.find(".name").text().toLowerCase().indexOf(a)?s.hide():s.show()})}),e(document).on("click",".bpbm-send-files.bpbm-has-files",function(s){var t=e(this).closest(".uppy-Dashboard"),a=parseInt(t.attr("data-thread-id")),i=e("#bpbm-upload-btn-"+a);t.find(".uppy-Dashboard-close").click();i.closest("form").submit()})}(BPBMJQ);